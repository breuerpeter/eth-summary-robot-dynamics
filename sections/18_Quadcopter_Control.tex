\section{QUADCOPTER CONTROL}

\begin{whitebox}{\textbf{OVERVIEW}}
    \begin{itemize}
        \item Goal: move quadcopter in space
        \item 6 DOF, underactuated system (not all states are independently controllable)
        \item System input: 4 motor speeds (propellers in cross configuration, with two pairs $(1,3)$ and $(2,4)$ turning in opposite directions; motor $1$ points forward)
        \item Full state feedback control (assume all states are known)
    \end{itemize}
\end{whitebox}

\begin{whitebox}{\textbf{ASSUMPTIONS}}
    \begin{itemize}
        \item Motor dynamics negligible
        \item Flight at low speeds
        \begin{itemize}
            \item Only dominant aerodynamic forces considered
            \item Linearization about small roll and pitch angles
        \end{itemize}
    \end{itemize}
\end{whitebox}

\begin{whitebox}{\textbf{INTUITION}}
    \begin{itemize}
        \item Vertical control (along $z$-axis): simultaneous change in all rotor speeds
        \item Directional control (around $z$-axis): rotor speed imbalance between the two rotor pairs
        \item Longitudinal control (forward): converse change of rotor speeds $1$ and $3$
        \item Lateral control (sideways): converse change of rotor speeds $2$ and $4$
    \end{itemize}
\end{whitebox}

\begin{whitebox}{\textbf{VIRTUAL CONTROL INPUTS}}
    \begin{itemize}
        \item Defining (4) virtual control inputs simplifies the equations of motion (yielding decoupled and linear inputs)
        \begin{itemize}
            \item Moments along each axis
            \begin{align*}
                &U_2:=lb(\omega_{p,4}^2-\omega_{p,2}^2)\\
                &\implies I_{xx}\dot{p}=qr(I_{yy}-I_{zz})+U_2\\
                &U_3:=lb(\omega_{p,1}^2-\omega_{p,3}^2)\\
                &\implies I_{yy}\dot{q}=pr(I_{zz}-I_{xx})+U_3\\
                &U_4:=d(-\omega_{p,1}^2+\omega_{p,2}^2-\omega_{p,3}^2+\omega_{p,3}^2)\\
                &\implies I_{zz}\dot{r}=U_4
            \end{align*}
            \item Total thrust
            \begin{align*}
                U_1=&b(\omega_{p,1}^2+\omega_{p,2}^2+\omega_{p,3}^2+\omega_{p,4}^2)\\
                \implies &m\dot{u}=m(rv-qw)-mg\sin\theta\\
                &m\dot{v}=m(pw-ru)+mg\sin\phi\cos\theta\\
                &m\dot{w}=m(qu-pv)+mg\cos\phi\cos\theta-U_1
            \end{align*}
        \end{itemize}
    \end{itemize}
\end{whitebox}

\begin{whitebox}{\textbf{HIERARCHICAL (CASCADED) CONTROL}}
    \begin{itemize}
        \item Rotational dynamics independent of translational dynamics
        \item Cascaded control structure
        \begin{itemize}
            \item Inner loop: attitude control
            \begin{itemize}
                \item Inputs: $U_1,U_2,U_3$
            \end{itemize}
            \item Outer loop: position control
            \begin{itemize}
                \item Inputs: $U_1,\phi,\theta$
            \end{itemize}
        \end{itemize}
    \end{itemize}
\end{whitebox}

\begin{whitebox}{\textbf{LINEARIZED DYNAMICS AROUND HOVER}}
    \begin{itemize}
        \item Equilibrium (hover conditions)
        \begin{itemize}
            \item $\phi=\theta=0\implies\bm{E}_{R,\mathrm{Euler},ZYX}=\mathbb{I}_{3\times3}\implies\ _\mathcal{B}\bm{\omega}_\mathcal{EB}=\dot{\bm{\Theta}}$
            \item $p=q=r=0$
            \item $U_2=U_3=U_4=0$
            \item $U_1=mg$
        \end{itemize}
        \item Linearized rotational dynamics (no couplings)
        \begin{align*}
            \ddot{\phi}=\frac{1}{I_{xx}}U_2,\quad
            \ddot{\theta}=\frac{1}{I_{yy}}U_3,\quad
            \ddot{\psi}=\frac{1}{I_{zz}}U_4
        \end{align*}
    \end{itemize}
\end{whitebox}

\begin{whitebox}{\textbf{PD ATTITUDE CONTROL}}
    \begin{itemize}
        \item P controller not sufficient
        \begin{itemize}
            \item Example: roll subsystem
            \begin{align*}
                U_2=k_p(\phi^*-\phi)\implies\ddot{\phi}=\frac{1}{I_{xx}}k_p(\phi^*-\phi)
            \end{align*}
            (Undamped harmonic oscillator)
        \end{itemize}
        \item PD controller for the 3 separate attitude subsystems
        \begin{align*}
            &U_2=k_{p,\mathrm{Roll}}(\phi^*-\phi)-\dot{\phi}k_{d,\mathrm{Roll}}\\
            &U_3=k_{p,\mathrm{Pitch}}(\theta^*-\theta)-\dot{\theta}k_{d,\mathrm{Pitch}}\\
            &U_4=k_{p,\mathrm{Yaw}}(\psi^*-\psi)-\dot{\psi}k_{d
            ,\mathrm{Yaw}}
        \end{align*}
        \item Angular rates from transformation of body angular rates
        \item Avoid integral elements in controller
        \item Parameter tuning
        \begin{itemize}
            \item $k_p$ chosen to get desired convergence time
            \item $k_d$ chosen to get desired damping
        \end{itemize}
        \faWarning\ Actuator dynamics limit the control signal bandwidth and actuator signals mustn't saturate motors
        \item Thrust input $U_1=T^*$
    \end{itemize}
\end{whitebox}

\begin{whitebox}{\textbf{CONTROL ALLOCATION}}
    \begin{itemize}
        \item Transform virtual control inputs to rotor speeds using the allocation matrix
        \begin{align*}
            &\begin{bmatrix}
                U_1\\
                U_2\\
                U_3\\
                U_4
            \end{bmatrix}=
            \begin{bmatrix}
                b & b & b & b\\
                0 & -lb & 0 & lb\\
                lb & 0 & -lb & 0\\
                -d & d & -d & d
            \end{bmatrix}
            \begin{bmatrix}
                \omega_{p,1}^2\\
                \omega_{p,2}^2\\
                \omega_{p,3}^2\\
                \omega_{p,4}^2
            \end{bmatrix}\\
            \implies
            &\begin{bmatrix}
                \omega_{p,1}^2\\
                \omega_{p,2}^2\\
                \omega_{p,3}^2\\
                \omega_{p,4}^2
            \end{bmatrix}=\underbrace{
            \begin{bmatrix}
                \frac{1}{4b} & 0 & \frac{1}{2lb} & -\frac{1}{4d}\\
                \frac{1}{4b} & -\frac{1}{2lb} & 0 & \frac{1}{4d}\\
                \frac{1}{4b} & 0 & -\frac{1}{2lb} & -\frac{1}{4d}\\
                \frac{1}{4b} & \frac{1}{2lb} & 0 & \frac{1}{4d}
            \end{bmatrix}}_{\text{Allocation matrix}}
            \begin{bmatrix}
                U_1\\
                U_2\\
                U_3\\
                U_4
            \end{bmatrix}
        \end{align*}
        \item Limit motor speeds to feasible (positive) values
    \end{itemize}
\end{whitebox}

\begin{whitebox}{\textbf{TRANSLATIONAL DYNAMICS W.R.T. INERTIAL FRAME}}
   \begin{enumerate}
        \item Conservation of linear momentum
        \begin{align*}
            \dot{\bm{p}}_S=\sfrac{d}{dt}\left(m\bm{v}_S\right)=m\bm{a}_S=\bm{F}_\mathrm{ext}
        \end{align*}
        \item Modified notation
        \begin{align*}
            \dot{\bm{p}}_B=\sfrac{d}{dt}\left(m\dot{\bm{r}}_{EB}\right)=m\ddot{\bm{r}}_{EB}=\bm{F}
        \end{align*}
        \item Express vectors in $\mathcal{E}$
        \begin{align*}
            m\ _\mathcal{E}\ddot{r}_{EB}=\ _\mathcal{E}\bm{F}
        \end{align*}
        \item The resultant force is composed of the thrust (other aerodynamic forces neglected) and gravity
        \begin{align*}
            _\mathcal{E}\ddot{r}_{EB}&=
            \begin{bmatrix}
                0\\
                0\\
                g
            \end{bmatrix}+\frac{1}{m}\bm{C}_\mathcal{EB}\ _\mathcal{B}\bm{F}_\mathrm{Thrust}=
            \begin{bmatrix}
                0\\
                0\\
                g
            \end{bmatrix}+\frac{1}{m}\bm{C}_\mathcal{EB}
            \begin{bmatrix}
                0\\
                0\\
                -U_1
            \end{bmatrix}\\   
        \end{align*}
        \item Define the components of the thrust force vector w.r.t $\mathcal{E}$
        \begin{align*}
            &_\mathcal{E}\bm{F}_\mathrm{Thrust}=
            \begin{bmatrix}
                T_x\\
                T_y\\
                T_z
            \end{bmatrix}=U_1
            \begin{bmatrix}
                s_\phi s_\psi+c_\phi c_\psi s_\theta\\
                c_\phi s_\theta s_\psi-c_\psi s_\phi\\
                c_\phi c_\theta
            \end{bmatrix}\\
            &\implies_\mathcal{E}\ddot{r}_{EB}=
            \begin{bmatrix}
                \ddot{x}\\
                \ddot{y}\\
                \ddot{z}
            \end{bmatrix}=
            \begin{bmatrix}
                0\\
                0\\
                g
            \end{bmatrix}-\frac{1}{m}\ _\mathcal{E}\bm{F}_\mathrm{Thrust}\\ 
        \end{align*}
    \end{enumerate}
\end{whitebox}


\begin{whitebox}{\textbf{ALTITUDE CONTROL}}
    \begin{itemize}
        \item Vertical equation of translation dynamics w.r.t. $\mathcal{E}$
        \begin{align*}
            \ddot{z}=g-\frac{1}{m}U_1\cos\phi\cos\theta
        \end{align*}
        \item Define vertical thrust force w.r.t. $\mathcal{E}$ as virtual control
        \begin{align*}
            T_z:=U_1\cos\phi\cos\theta \implies\ddot{z}=g-\frac{1}{m}T_z
        \end{align*}
        \item PD altitude control % TODO: why is there a minus?
        \begin{align*}
            T_z=-k_{p,z}(z^*-z)+k_{d,z}\dot{z}-mg
        \end{align*}
        \item Transformation back to $\mathcal{B}$
        \begin{align*}
            U_1=\frac{T_z}{\cos\phi\cos\theta}
        \end{align*}
    \end{itemize}
\end{whitebox}

\begin{whitebox}{\textbf{FULL POSITION CONTROL}}
    \begin{enumerate}
        \item 3 separate PD controllers for directions of thrust force vector w.r.t. $\mathcal{E}$ % TODO: check minuses in front of kps
        \begin{align*}
            \begin{bmatrix}
                T_x\\
                T_y\\
                T_z
            \end{bmatrix}=
            \begin{bmatrix}
                -k_{p,x}(x^*-x)+k_{d,x}\dot{x}\\
                -k_{p,y}(y^*-y)+k_{d,y}\dot{y}\\
                -k_{p,z}(z^*-z)+k_{d,z}\dot{z}-mg\\
            \end{bmatrix}
        \end{align*}
        \item Calculate the corresponding total thrust
        \begin{align*}
            U_1=\sqrt{T_x^2+T_y^2+T_z^2}
        \end{align*}
        \item Calculate the corresponding roll and pitch angles after aligning the thrust force vector with the yaw angle
        \begin{small}
            \begin{align*}
                \frac{1}{U_1}
                \begin{bmatrix}
                    T_x\\
                    T_y\\
                    T_z
                \end{bmatrix}&=
                \begin{bmatrix}
                    s_\phi s_\psi+c_\phi c_\psi s_\theta\\
                    c_\phi s_\theta s_\psi-c_\psi s_\phi\\
                    c_\phi c_\theta
                \end{bmatrix}\\
                \implies\frac{1}{U_1}\bm{C}_{\mathcal{E}1}(z,\psi)^\top
                \begin{bmatrix}
                    T_x\\
                    T_y\\
                    T_z
                \end{bmatrix}&=\bm{C}_{\mathcal{E}1}(z,\psi)^\top
                \begin{bmatrix}
                    s_\phi s_\psi+c_\phi c_\psi s_\theta\\
                    c_\phi s_\theta s_\psi-c_\psi s_\phi\\
                    c_\phi c_\theta
                \end{bmatrix}\\
    \           \implies\frac{1}{U_1}\bm{C}_{1\mathcal{E}}(z,\psi)
                \begin{bmatrix}
                    T_x\\
                    T_y\\
                    T_z
                \end{bmatrix}&=
                \begin{bmatrix}
    				c_\psi & s_\psi & 0\\
    				-s_\psi & c_\psi & 0\\
    				0 & 0 & 1
    			\end{bmatrix}
                \begin{bmatrix}
                    s_\phi s_\psi+c_\phi c_\psi s_\theta\\
                    c_\phi s_\theta s_\psi-c_\psi s_\phi\\
                    c_\phi c_\theta
                \end{bmatrix}\\
                &=
                \begin{bmatrix}
                    \sin\theta\cos\phi\\
                    -\sin\phi\\
                    \cos\theta\cos\phi
                \end{bmatrix}
            \end{align*}            
        \end{small}
        \item PD attitude control
        \item Control allocation
        
    \end{enumerate}
\end{whitebox}
